- name: install keepalived
  apt:
    name: [keepalived]
    state: present

- name: copy keepalived
  template:
    src: keepalived.conf.j2
    dest: /etc/keepalived/keepalived.conf
    mode: 0644
  notify:
    - keepalived restart

#---------------------------------------------------------------------
### Keepalived Exporter
#---------------------------------------------------------------------
- block:
    - name: Download keepalived-exporter package
      get_url:
        url: https://github.com/mehdy/keepalived-exporter/releases/download/v{{keepalived_exporter_config.version}}/keepalived-exporter-{{keepalived_exporter_config.version}}.linux-amd64.deb
        dest: /tmp/keepalived-exporter-{{keepalived_exporter_config.version}}.linux-amd64.deb

    - name: Install keepalived-exporter package
      become: true
      apt:
        deb: /tmp/keepalived-exporter-{{keepalived_exporter_config.version}}.linux-amd64.deb

    - name: copy keepalived exporter
      template:
        src: keepalived-exporter.service.j2
        dest: /etc/systemd/system/keepalived-exporter.service
        mode: 0644
      notify:
        - keepalived-exporter restart
  when: keepalived_exporter == true